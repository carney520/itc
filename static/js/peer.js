(window.webpackJsonp=window.webpackJsonp||[]).push([[3],[,,function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.EVENTS={CONNECTED:"CONNECTED",INITIAL:"INITIAL",PONG:"PONG",PING:"PING",BECOME_MASTER:"BECOME_MASTER",DESTORY:"DESTROY",MESSAGE:"MESSAGE",UPDATE_PEERS:"UPDATE_PEERS",UPDATE_MASTER:"UPDATE_MASTER",CALL:"CALL",CALL_RESPONSE:"CALL_RESPONSE"},t.ERRORS={NOT_FOUND:"NOT_FOUND",IGNORED:"IGNORED"},t.INNER_CALL={CHECK_ALIVE:"CHECK_ALIVE"},t.BroadcastPeer={id:"*",name:"broadcast"}},,function(e,t,r){},,function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var n=r(2),s=0,a=function(){function e(e){var t=this;this.ready=!1,this.destroyed=!1,this.queue={},this.defaultTimeout=3e3,this.callbacks={},this.handlers={},this.pendingQueue=[],this.watchingReady=[],this.name=e,this.on("ready",function(){t.ready=!0,t.flushPendingQueue()}),this.on("destroy",function(){t.ready=!1,t.destroyed=!0}),this.on("eventadded",function(e){switch(e.event){case"ready":t.ready&&e.handle(void 0);break;case"master":t.ready&&t.isMaster().then(function(t){return t&&e.handle(void 0)})}})}return e.prototype.on=function(e,t){var r=this;return e in this.queue?this.queue[e].push(t):this.queue[e]=[t],"eventadded"!==e&&this.emit("eventadded",{event:e,handle:t}),function(){r.off(e,t)}},e.prototype.off=function(e,t){if(e in this.queue){var r=this.queue[e].indexOf(t);-1!==r&&this.queue[e].splice(r,1)}},e.prototype.emit=function(e,t){e in this.queue&&this.queue[e].slice().forEach(function(e){return e(t)})},e.prototype.setCallTimeout=function(e){this.defaultTimeout=e},e.prototype.send=function(e,t){void 0===t&&(t=n.BroadcastPeer),this.checkWorkerAvailable(),this.ready?this.postMessage(t,{type:n.EVENTS.MESSAGE,data:e}):this.pendingQueue.push({peer:t,data:e})},e.prototype.call=function(e,t){for(var r=this,n=[],s=2;s<arguments.length;s++)n[s-2]=arguments[s];return this.checkWorkerAvailable(),this.waitReady().then(function(){return r.callInternal(e,t,n,r.defaultTimeout)})},e.prototype.response=function(e,t){if(e in this.handlers)throw new Error("handler for "+e+" was existed");this.handlers[e]=t},e.prototype.waitReady=function(){var e=this;return new Promise(function(t){e.ready?t():e.watchingReady.push(t)})},e.prototype.callInternal=function(e,t,r,a){var i=this;return new Promise(function(o,u){var c,d=!1,h=s++,p=function(e){d||(d=!0,delete i.callbacks[h],u(e))};i.callbacks[h]={resolver:function(e){d||(d=!0,c&&clearTimeout(c),delete i.callbacks[h],o(e))},rejecter:p,name:t,args:r};var l={type:n.EVENTS.CALL,data:{name:t,id:h,args:r}};i.postMessage(e,l),null!=a&&(c=window.setTimeout(function(){p(new Error("timeout"))},a))})},e.prototype.callReturn=function(e,t){var r=t.id,n=t.data,s=t.error,a=t.name;if(this.callbacks[r]){var i=this.callbacks[r],o=i.resolver,u=i.rejecter;null!=s?u(new Error(s)):o(n)}else console.warn("callbacks["+a+"] for id("+r+") not found!")},e.prototype.responseInternal=function(e,t){var r,s=this,a=t.id,i=t.name,o=t.args,u={type:n.EVENTS.CALL_RESPONSE,data:{id:a,name:i}};this.handlers[i]?(r=this.handlers)[i].apply(r,[e].concat(o)).then(function(t){u.data.data=t,s.postMessage(e,u)}).catch(function(t){u.data.error=t.message,s.postMessage(e,u)}):(u.data.error=n.ERRORS.NOT_FOUND,this.postMessage(e,u))},e.prototype.checkWorkerAvailable=function(){if(this.destroyed)throw new Error("[itc]: current worker was destroyed.")},e.prototype.flushPendingQueue=function(){var e=this,t=this.pendingQueue;this.pendingQueue=[],t.forEach(function(t){return e.send(t.data,t.peer)});var r=this.watchingReady;this.watchingReady=[],r.forEach(function(e){return e()})},e}();t.default=a},function(e,t,r){"use strict";function n(){return Math.floor(65536*Math.random()).toString(16)}Object.defineProperty(t,"__esModule",{value:!0}),t.hash=function(e){var t=0;if(e.length)for(var r=0;r<e.length;r++)t=(t<<5)-t+e.charCodeAt(r),t|=0;return t.toString(36)},t.uuid=function(){return n()+n()+"-"+n()+"-"+n()+"-"+n()+"-"+n()+n()+n()},t.delay=function(e){return void 0===e&&(e=0),new Promise(function(t){return setTimeout(t,e)})},t.getRandomIntInclusive=function(e,t){return e=Math.ceil(e),t=Math.floor(t),Math.floor(Math.random()*(t-e+1))+e},t.objEquals=function(e,t){for(var r=[],n=2;n<arguments.length;n++)r[n-2]=arguments[n];for(var s in e)if(e.hasOwnProperty(s)){if(-1!==r.indexOf(s))continue;if(e[s]!==t[s])return!1}return!0}},function(e,t,r){"use strict";var n=this&&this.__assign||function(){return(n=Object.assign||function(e){for(var t,r=1,n=arguments.length;r<n;r++)for(var s in t=arguments[r])Object.prototype.hasOwnProperty.call(t,s)&&(e[s]=t[s]);return e}).apply(this,arguments)};Object.defineProperty(t,"__esModule",{value:!0});var s,a=r(18);t.Worker=a.Worker;var i={useStorage:!1};t.default=function(e,t){return t=n({},i,t||{}),s&&!s.destroyed?s:s=t.useStorage||!a.Worker.isSupport?new a.Storage(e):new a.Worker(e)}},,,,,,,,function(e,t,r){e.exports=r(17)},function(e,t,r){"use strict";r.r(t);var n=r(1),s=r(8),a=r.n(s),i=r(0),o=r.n(i),u=r(3),c=r.n(u);r(4);c.a.render(o.a.createElement(function(){var e=Object(i.useRef)({}),t=Object(i.useState)(!1),r=Object(n.a)(t,2),s=r[0],u=r[1],c=Object(i.useState)(void 0),d=Object(n.a)(c,2),h=d[0],p=d[1],l=Object(i.useState)([]),f=Object(n.a)(l,2),m=f[0],E=f[1],v=Object(i.useState)([0,0]),y=Object(n.a)(v,2),g=y[0],w=y[1],M=Object(i.useCallback)(function(t){var r=[t.clientX,t.clientY];w(r),e.current.worker&&e.current.worker.send(r)},[]);return Object(i.useEffect)(function(){var t=location.search.match(/name=(.*)$/)[1],r=e.current.worker=a()(t,{useStorage:!0});r.on("master",function(){u(!0)}),r.on("masterlose",function(){u(!1)}),r.on("masterupdate",function(e){p(e)}),r.on("peerupdate",function(e){E(e)}),r.on("message",function(e){w(e)})},[]),o.a.createElement("div",{className:"".concat(s?"master":""," peer"),onMouseMove:M},o.a.createElement("div",null,"current master: ",h&&h.name),o.a.createElement("div",null,"peers: [",m.map(function(e){return e.name}).join(", "),"]"),o.a.createElement("div",{className:"ball",style:{left:g[0],top:g[1]}}))},null),document.getElementById("root"))},function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),function(e){for(var r in e)t.hasOwnProperty(r)||(t[r]=e[r])}(r(2));var n=r(19);t.Worker=n.default;var s=r(20);t.Storage=s.default},function(e,t,r){"use strict";var n=this&&this.__extends||function(){var e=function(t,r){return(e=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var r in t)t.hasOwnProperty(r)&&(e[r]=t[r])})(t,r)};return function(t,r){function n(){this.constructor=t}e(t,r),t.prototype=null===r?Object.create(r):(n.prototype=r.prototype,new n)}}(),s=this&&this.__assign||function(){return(s=Object.assign||function(e){for(var t,r=1,n=arguments.length;r<n;r++)for(var s in t=arguments[r])Object.prototype.hasOwnProperty.call(t,s)&&(e[s]=t[s]);return e}).apply(this,arguments)},a=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0});var i=a(r(6)),o=r(7),u=r(2),c={id:-1,name:"worker"};t.MAX_TRY_TIME=4;var d=function(e){function r(r){var n=e.call(this,r)||this;return n.id=0,n.tryTimes=0,n.peers=[],n.destroy=function(){n.destroyed||(window.removeEventListener("unload",n.destroy),n.worker&&(n.worker.port.removeEventListener("message",n.onMessage),n.postMessage(c,{type:u.EVENTS.DESTORY}),n.worker=void 0),n.emit("destroy"))},n.initializeWorker=function(){if(!(n.tryTimes>=t.MAX_TRY_TIME)){n.tryTimes++;try{n.worker=new SharedWorker(n.genSource())}catch(e){return console.warn("[itc] SharedWorker Error: ",e),void n.initializeWorker()}n.worker.addEventListener("error",n.handleWorkerError),n.worker.port.addEventListener("message",n.onMessage),n.worker.port.start()}},n.handleWorkerError=function(e){var t=e,r=t.filename,s=t.lineno,a=t.colno,i=t.message;console.warn("[itc] SharedWorker Error in "+r+"("+s+":"+a+"): "+i),n.worker&&(n.worker.port.removeEventListener("message",n.onMessage),n.worker.removeEventListener("error",n.handleWorkerError),n.worker=void 0),n.initializeWorker()},n.onMessage=function(e){var t=e.data,r=(t.target,t.source),s=t.type,a=t.data;if(!r||r.id!==n.id)switch(s){case u.EVENTS.PING:n.postMessage(c,{type:u.EVENTS.PONG});break;case u.EVENTS.BECOME_MASTER:n.emit("master"),console.log("master");break;case u.EVENTS.CONNECTED:var i=a,o=i.id,d=i.peers,h=i.master,p={name:n.name};n.id=o,n.peers=d,n.currentMaster=h,n.postMessage(c,{type:u.EVENTS.INITIAL,data:p}),n.emit("ready"),console.log("ready");break;case u.EVENTS.MESSAGE:n.emit("message",a);break;case u.EVENTS.CALL:n.responseInternal(r,a);break;case u.EVENTS.CALL_RESPONSE:n.callReturn(r,a);break;case u.EVENTS.UPDATE_PEERS:n.peers=a,n.emit("peerupdate",n.peers),console.log("peer update");break;case u.EVENTS.UPDATE_MASTER:var l=n.currentMaster;n.currentMaster=a,l&&l.id===n.id&&l.id!==n.currentMaster.id&&(console.log("master lose"),n.emit("masterlose")),n.emit("masterupdate",n.currentMaster),console.log("master update");break;default:console.warn("[itc] unknown events: "+s)}},n.initializeWorker(),window.addEventListener("unload",n.destroy),n}return n(r,e),Object.defineProperty(r.prototype,"current",{get:function(){return{id:this.id,name:this.name}},enumerable:!0,configurable:!0}),r.prototype.getPeers=function(){var e=this;return this.checkWorkerAvailable(),this.waitReady().then(function(){return e.peers})},r.prototype.getMaster=function(){var e=this;return this.checkWorkerAvailable(),this.waitReady().then(function(){return e.currentMaster})},r.prototype.isMaster=function(){var e=this;return this.getMaster().then(function(t){return!!t&&t.id===e.id})},r.prototype.postMessage=function(e,t){if(!this.destroyed)if(e.id!==this.id){var r=s({target:e.id,source:this.current},t);this.worker.port.postMessage(r)}else console.warn("[itc] cannot postMessage to self")},r.prototype.genSource=function(){var e=this.getSource(),t="itc-sw-"+o.hash(e),r=window.localStorage.getItem(t);if(r)return r;var n="data:text/javascript;base64,"+btoa(e);return window.localStorage.setItem(t,n),n},r.prototype.getSource=function(){return"\n    (function(window){\n      ("+h.toString()+")("+JSON.stringify(u.EVENTS)+", window);\n    })(this)\n    "},r.isSupport=!(!window.btoa||!window.SharedWorker),r}(i.default);function h(e,t){return new(function(){function t(e){this.ports=[],this.uid=0,this.scope=e,this.listen(),this.heartbeat()}return t.prototype.checkMaster=function(){null==this.master&&this.ports.length&&(this.master=this.ports[0],this.master.postMessage({type:e.BECOME_MASTER}),this.broadcast({type:e.UPDATE_MASTER,data:{id:this.master.id,name:this.master.name}}))},t.prototype.removePort=function(e){var t=this.ports.indexOf(e);-1!==t&&this.ports.splice(t,1),this.master===e&&(this.master=void 0),this.updatePeer(),this.checkMaster()},t.prototype.getPeers=function(e){return this.ports.filter(function(t){return t.id!==e.id}).map(function(e){return{id:e.id,name:e.name}})},t.prototype.updatePeer=function(t){var r=this;this.ports.filter(function(e){return e!==t}).forEach(function(t){var n=r.getPeers(t);t.postMessage({type:e.UPDATE_PEERS,data:n})})},t.prototype.broadcast=function(e,t){this.ports.filter(function(e){return e!==t}).forEach(function(t){return t.postMessage(e)})},t.prototype.postMessage=function(e,t){if(null!=e.target&&"*"!==e.target){if(-1!==e.target){var r=this.ports.findIndex(function(t){return t.id===e.target});-1!==r&&this.ports[r].postMessage(e)}}else this.broadcast(e,t)},t.prototype.heartbeat=function(){var t=this;setTimeout(function(){for(var r=t.ports.length;r--;){var n=t.ports[r];n.zoombie?t.removePort(n):(n.zoombie=!0,n.postMessage({type:e.PING}))}t.heartbeat()},500)},t.prototype.listen=function(){var t=this;this.scope.addEventListener("connect",function(r){var n=r.ports[0];n.id=t.uid++,n.addEventListener("message",function(r){-1===t.ports.indexOf(n)&&(t.ports.push(n),t.checkMaster(),t.updatePeer(),t.postMessage({target:n.id,type:e.UPDATE_MASTER,data:{id:t.master.id,name:t.master.name}}));var s=r.data;switch(s.type){case e.PONG:n.zoombie=!1;break;case e.MESSAGE:t.postMessage(s,n);break;case e.DESTORY:t.removePort(n);break;case e.INITIAL:var a=s.data.name;n.name=a,t.updatePeer(n);break;default:t.postMessage(s,n)}}),t.ports.push(n),n.start();var s=t.master||n,a={id:n.id,peers:t.getPeers(n),master:{name:s.name,id:s.id}};n.postMessage({type:e.CONNECTED,data:a}),t.checkMaster()})},t}())(t)}t.default=d,t.workerSource=h},function(e,t,r){"use strict";var n=this&&this.__extends||function(){var e=function(t,r){return(e=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var r in t)t.hasOwnProperty(r)&&(e[r]=t[r])})(t,r)};return function(t,r){function n(){this.constructor=t}e(t,r),t.prototype=null===r?Object.create(r):(n.prototype=r.prototype,new n)}}(),s=this&&this.__assign||function(){return(s=Object.assign||function(e){for(var t,r=1,n=arguments.length;r<n;r++)for(var s in t=arguments[r])Object.prototype.hasOwnProperty.call(t,s)&&(e[s]=t[s]);return e}).apply(this,arguments)},a=this&&this.__awaiter||function(e,t,r,n){return new(r||(r=Promise))(function(s,a){function i(e){try{u(n.next(e))}catch(t){a(t)}}function o(e){try{u(n.throw(e))}catch(t){a(t)}}function u(e){e.done?s(e.value):new r(function(t){t(e.value)}).then(i,o)}u((n=n.apply(e,t||[])).next())})},i=this&&this.__generator||function(e,t){var r,n,s,a,i={label:0,sent:function(){if(1&s[0])throw s[1];return s[1]},trys:[],ops:[]};return a={next:o(0),throw:o(1),return:o(2)},"function"===typeof Symbol&&(a[Symbol.iterator]=function(){return this}),a;function o(a){return function(o){return function(a){if(r)throw new TypeError("Generator is already executing.");for(;i;)try{if(r=1,n&&(s=2&a[0]?n.return:a[0]?n.throw||((s=n.return)&&s.call(n),0):n.next)&&!(s=s.call(n,a[1])).done)return s;switch(n=0,s&&(a=[2&a[0],s.value]),a[0]){case 0:case 1:s=a;break;case 4:return i.label++,{value:a[1],done:!1};case 5:i.label++,n=a[1],a=[0];continue;case 7:a=i.ops.pop(),i.trys.pop();continue;default:if(!(s=(s=i.trys).length>0&&s[s.length-1])&&(6===a[0]||2===a[0])){i=0;continue}if(3===a[0]&&(!s||a[1]>s[0]&&a[1]<s[3])){i.label=a[1];break}if(6===a[0]&&i.label<s[1]){i.label=s[1],s=a;break}if(s&&i.label<s[2]){i.label=s[2],i.ops.push(a);break}s[2]&&i.ops.pop(),i.trys.pop();continue}a=t.call(e,i)}catch(o){a=[6,o],n=0}finally{r=s=0}if(5&a[0])throw a[1];return{value:a[0]?a[1]:void 0,done:!0}}([a,o])}}},o=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0});var u=r(7),c=r(2),d=o(r(6));t.NAMESPACE="_ITC_",t.HEART_BEAT=2500,t.MASTER_HEART_BEAT=1e3,t.ZOOMBIE_THRESHOLD=4e3;var h=new RegExp("^"+t.NAMESPACE+"\\.([^\\.]*)$"),p=function(e){function r(r,n){var s=e.call(this,r)||this;return s.id=u.uuid(),s.peers=[],s.storage=window.localStorage,s.destroy=function(){s.destroyed||(s.ready&&s.postMessage(c.BroadcastPeer,{type:c.EVENTS.DESTORY}),window.removeEventListener("storage",s.onStorage),document.removeEventListener("storage",s.onStorage),window.removeEventListener("unload",s.destroy),s.heartBeatTimer&&(clearTimeout(s.heartBeatTimer),s.heartBeatTimer=void 0),s.masterHeartBeatTimer&&(clearTimeout(s.masterHeartBeatTimer),s.masterHeartBeatTimer=void 0),s.emit("destroy"),s.peers=[],s.currentMaster=void 0)},s.onStorage=function(e){var r=e,n=r.key,a=r.newValue;r.oldValue;if(null==n||!n.startsWith(t.NAMESPACE)||null==a)return!1;var i=n.match(h);if(null==i)return!1;var o=JSON.parse(a),u=i[1];switch(u){case"master":console.log("master",o,s.name),s.updateMaster(o);break;case"message":return s.handleMessage(o);default:return console.warn("[itc] unknown event: "+u),!1}return!0},s.checkMasterAlive=function(){return a(s,void 0,void 0,function(){var e,t,r;return i(this,function(n){switch(n.label){case 0:if(this.destroyed)return[2];e=u.getRandomIntInclusive(2,4),r=0,n.label=1;case 1:if(!(r<e))return[3,7];n.label=2;case 2:return n.trys.push([2,4,,6]),t=this.currentMaster,[4,this.callInternal(this.currentMaster,c.INNER_CALL.CHECK_ALIVE,[],1e3)];case 3:return"correction"===n.sent().status&&this.updateMaster(this.getItem("master")),this.masterHeartBeat(),[3,7];case 4:return n.sent(),r===e-1?(t&&t!==this.currentMaster?this.masterHeartBeat():(this.currentMaster=void 0,this.checkMaster(!0)),[3,7]):[4,u.delay()];case 5:return n.sent(),[3,6];case 6:return r++,[3,1];case 7:return[2]}})})},n&&(s.storage=n),console.log("current",s.id,s.name),s.initializeInnerHandler(),s.connect(),s}return n(r,e),Object.defineProperty(r.prototype,"current",{get:function(){return{id:this.id,name:this.name}},enumerable:!0,configurable:!0}),r.prototype.getMaster=function(){var e=this;return this.checkWorkerAvailable(),this.waitReady().then(function(){return e.currentMaster})},r.prototype.isMaster=function(){var e=this;return this.checkWorkerAvailable(),this.getMaster().then(function(t){return!!t&&t.id===e.id})},r.prototype.getPeers=function(){var e=this;return this.checkWorkerAvailable(),this.waitReady().then(function(){return e.peers})},r.prototype.initializeInnerHandler=function(){var e=this;this.response(c.INNER_CALL.CHECK_ALIVE,function(t){return e.currentMaster?e.currentMaster.id===e.id?Promise.resolve({status:"ok"}):(console.log("master correct","from("+t.name+") -> "+e.name+": "+e.currentMaster.name),Promise.resolve({status:"correction"})):Promise.reject(c.ERRORS.IGNORED)})},r.prototype.connect=function(){return a(this,void 0,void 0,function(){return i(this,function(e){switch(e.label){case 0:return this.currentMaster=void 0,window.addEventListener("storage",this.onStorage),document.addEventListener("storage",this.onStorage),window.addEventListener("unload",this.destroy),[4,this.checkMaster()];case 1:return e.sent(),this.heartbeat(!0),this.emit("ready"),[2]}})})},r.prototype.handleMessage=function(e){var t=e.target,r=e.source,n=e.data;if(t!==this.id&&"*"!==t)return!1;if(r.id===this.id)return!1;switch(n.type){case c.EVENTS.PING:this.postMessage(r,{type:c.EVENTS.PONG});break;case c.EVENTS.PONG:return this.updatePeer(r);case c.EVENTS.DESTORY:this.removePeer(r);break;case c.EVENTS.CALL:this.responseInternal(r,n.data);break;case c.EVENTS.CALL_RESPONSE:this.callReturn(r,n.data);break;case c.EVENTS.MESSAGE:this.emit("message",n.data);break;default:return console.warn("[itc] unknown message event: "+n.type),!1}return!0},r.prototype.checkMaster=function(e){return a(this,void 0,void 0,function(){return i(this,function(t){switch(t.label){case 0:return[4,this.preemptMaster(e)];case 1:return t.sent(),this.currentMaster.id!==this.id?this.masterHeartBeat():this.masterHeartBeatTimer&&window.clearTimeout(this.masterHeartBeatTimer),[2]}})})},r.prototype.updateMaster=function(e){var t=this.currentMaster;this.currentMaster=e,t&&t.id===this.id&&t.id!==this.currentMaster.id&&(console.log("master lose",this.name),this.emit("masterlose"),this.masterHeartBeat()),null!=t&&t.id===e.id||(e.id===this.id&&this.emit("master"),this.emit("masterupdate",e)),this.pendingPreempt&&(this.pendingPreempt(),this.pendingPreempt=void 0)},r.prototype.preemptMaster=function(e){return a(this,void 0,void 0,function(){var t,r=this;return i(this,function(n){switch(n.label){case 0:if(this.currentMaster)return[2];if(!(t=this.getItem("master"))||e)return[3,7];if(t.id===this.id)return this.currentMaster=t,this.emit("master"),this.emit("masterupdate",t),[2];n.label=1;case 1:return n.trys.push([1,3,,6]),[4,this.callInternal(t,c.INNER_CALL.CHECK_ALIVE,[],500)];case 2:return"correction"===n.sent().status?(this.updateMaster(this.getItem("master")),[2]):(console.log("master existed",t.id,this.id,this.name),this.currentMaster=t,this.emit("masterupdate",t),[3,6]);case 3:return n.sent(),console.log("master no alive",t.id,this.id,this.name),[4,u.delay()];case 4:return n.sent(),[4,this.preemptMaster(!0)];case 5:return[2,n.sent()];case 6:return[3,9];case 7:return console.log("preempt master",this.name),this.setItem("master",this.current),[4,new Promise(function(e){var t=!1,n=function(){if(!t){if(t=!0,!r.currentMaster){var n=r.getItem("master");r.currentMaster=n,n.id===r.id&&r.emit("master"),r.emit("masterupdate",n)}e()}};r.pendingPreempt=n,window.setTimeout(n,100)})];case 8:n.sent(),n.label=9;case 9:return[2]}})})},r.prototype.masterHeartBeat=function(){this.currentMaster&&this.currentMaster.id===this.id||(this.masterHeartBeatTimer=window.setTimeout(this.checkMasterAlive,t.MASTER_HEART_BEAT))},r.prototype.heartbeat=function(e){var r=this;this.heartBeatTimer=window.setTimeout(function(){r.destroyed||(r.postMessage(c.BroadcastPeer,{type:c.EVENTS.PING}),r.updatePeers(),r.heartbeat())},e?0:t.HEART_BEAT)},r.prototype.updatePeer=function(e){if(e.id===this.id)return!1;var t=!1,r=this.peers.findIndex(function(t){return t.id===e.id});return-1!==r?(u.objEquals(this.peers[r],e,"lastUpdate")||(t=!0),this.peers[r]=s({},e,{lastUpdate:Date.now()})):(this.peers.push(s({},e,{lastUpdate:Date.now()})),t=!0),t&&this.emitPeerUpdate(),t},r.prototype.removePeer=function(e){var t=this.peers.findIndex(function(t){return t.id===e.id});-1!==t&&(this.peers.splice(t,1),this.emitPeerUpdate())},r.prototype.updatePeers=function(){for(var e=this,r=[],n=0,s=this.peers.length;n<s;n++){var a=this.peers[n];Date.now()-a.lastUpdate>t.ZOOMBIE_THRESHOLD&&r.push(a)}r.forEach(function(t){var r=e.peers.findIndex(function(e){return e.id===t.id});-1!==r&&e.peers.splice(r,1)}),r.length&&this.emitPeerUpdate()},r.prototype.emitPeerUpdate=function(){this.emit("peerupdate",this.peers.map(function(e){return{id:e.id,name:e.name}}))},r.prototype.postMessage=function(e,t){if(!this.destroyed)if(e.id!==this.id){var r={target:e.id,source:this.current,data:t};this.setItem("message",r)}else console.warn("cannot postMessage to self",t)},r.prototype.removeItem=function(e){this.storage.removeItem(t.NAMESPACE+"."+e)},r.prototype.setItem=function(e,r){this.storage.setItem(t.NAMESPACE+"."+e,JSON.stringify(r))},r.prototype.getItem=function(e){var r=this.storage.getItem(t.NAMESPACE+"."+e);if(r)return JSON.parse(r)},r}(d.default);t.default=p}],[[16,0,1]]]);
//# sourceMappingURL=peer.js.map?8c4d3244